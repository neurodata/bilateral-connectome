
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fisher’s method vs. min (after multiple comparison’s correction) &#8212; Bilateral Connectome</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="_static/nd_logo_small.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/nd_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Bilateral Connectome</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="abstract.html">
   Abstract
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Preliminaries
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="outline.html">
   Outline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="unmatched_vs_matched.html">
   Unmatched vs. matched networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="define_data.html">
   Larval
   <em>
    Drosophila melanogaster
   </em>
   brain connectome
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Unmatched Tests
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="er_unmatched_test.html">
   A density-based test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sbm_unmatched_test.html">
   A group-based test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rdpg_unmatched_test.html">
   An embedding-based test
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Matched Tests
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="er_matched_test.html">
   A density-based test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sbm_matched_test.html">
   A group-based test
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nhypergeom_sims.html">
   An exact test for non-unity null odds ratios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="revamp_sbm_methods_sim.html">
   Comparing methods for SBM testing
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="references.html">
   References
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Slides
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/drexel.pdf">
   Drexel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/lab-meeting-2022-02-24.pdf">
   Lab meeting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/nmc.pdf">
   neuromatch 4.0
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/compare_sbm_methods_sim.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/neurodata/bilateral-connectome"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/neurodata/bilateral-connectome/issues/new?title=Issue%20on%20page%20%2Fcompare_sbm_methods_sim.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-for-simulations-alternative">
   Model for simulations (alternative)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#p-values-under-the-null">
   P-values under the null
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#p-values-under-the-alternative">
   P-values under the alternative
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#power-under-the-alternative">
   Power under the alternative
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Fisher’s method vs. min (after multiple comparison’s correction)</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-for-simulations-alternative">
   Model for simulations (alternative)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#p-values-under-the-null">
   P-values under the null
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#p-values-under-the-alternative">
   P-values under the alternative
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#power-under-the-alternative">
   Power under the alternative
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="fisher-s-method-vs-min-after-multiple-comparison-s-correction">
<h1>Fisher’s method vs. min (after multiple comparison’s correction)<a class="headerlink" href="#fisher-s-method-vs-min-after-multiple-comparison-s-correction" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pkg.utils</span> <span class="kn">import</span> <span class="n">set_warnings</span>

<span class="n">set_warnings</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">myst_nb</span> <span class="kn">import</span> <span class="n">glue</span> <span class="k">as</span> <span class="n">default_glue</span>
<span class="kn">from</span> <span class="nn">pkg.data</span> <span class="kn">import</span> <span class="n">load_network_palette</span><span class="p">,</span> <span class="n">load_node_palette</span><span class="p">,</span> <span class="n">load_unmatched</span>
<span class="kn">from</span> <span class="nn">pkg.io</span> <span class="kn">import</span> <span class="n">savefig</span>
<span class="kn">from</span> <span class="nn">pkg.plot</span> <span class="kn">import</span> <span class="n">set_theme</span>
<span class="kn">from</span> <span class="nn">pkg.stats</span> <span class="kn">import</span> <span class="n">stochastic_block_test</span>
<span class="kn">from</span> <span class="nn">graspologic.simulations</span> <span class="kn">import</span> <span class="n">sbm</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binom</span><span class="p">,</span> <span class="n">combine_pvalues</span>
<span class="kn">from</span> <span class="nn">pkg.stats</span> <span class="kn">import</span> <span class="n">binom_2samp</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="n">DISPLAY_FIGS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">FILENAME</span> <span class="o">=</span> <span class="s2">&quot;compare_sbm_methods_sim&quot;</span>


<span class="k">def</span> <span class="nf">gluefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">foldername</span><span class="o">=</span><span class="n">FILENAME</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">glue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;fig&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">DISPLAY_FIGS</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">glue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">savename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FILENAME</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">savename</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">savename</span>
    <span class="n">default_glue</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">set_theme</span><span class="p">()</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>

<span class="n">network_palette</span><span class="p">,</span> <span class="n">NETWORK_KEY</span> <span class="o">=</span> <span class="n">load_network_palette</span><span class="p">()</span>
<span class="n">node_palette</span><span class="p">,</span> <span class="n">NODE_KEY</span> <span class="o">=</span> <span class="n">load_node_palette</span><span class="p">()</span>
<span class="n">fisher_color</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">min_color</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">method_palette</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fisher&quot;</span><span class="p">:</span> <span class="n">fisher_color</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">min_color</span><span class="p">}</span>

<span class="n">GROUP_KEY</span> <span class="o">=</span> <span class="s2">&quot;simple_group&quot;</span>

<span class="n">left_adj</span><span class="p">,</span> <span class="n">left_nodes</span> <span class="o">=</span> <span class="n">load_unmatched</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">right_adj</span><span class="p">,</span> <span class="n">right_nodes</span> <span class="o">=</span> <span class="n">load_unmatched</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

<span class="n">left_labels</span> <span class="o">=</span> <span class="n">left_nodes</span><span class="p">[</span><span class="n">GROUP_KEY</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">right_labels</span> <span class="o">=</span> <span class="n">right_nodes</span><span class="p">[</span><span class="n">GROUP_KEY</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stat</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="n">stochastic_block_test</span><span class="p">(</span>
    <span class="n">left_adj</span><span class="p">,</span>
    <span class="n">right_adj</span><span class="p">,</span>
    <span class="n">labels1</span><span class="o">=</span><span class="n">left_labels</span><span class="p">,</span>
    <span class="n">labels2</span><span class="o">=</span><span class="n">right_labels</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span>
    <span class="n">combine_method</span><span class="o">=</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="model-for-simulations-alternative">
<h2>Model for simulations (alternative)<a class="headerlink" href="#model-for-simulations-alternative" title="Permalink to this headline">¶</a></h2>
<p>We have fit a stochastic block model to the left and right hemispheres. Say the
probabilities of group-to-group connections <em>on the left</em> are stored in the matrix
<span class="math notranslate nohighlight">\(B\)</span>, so that <span class="math notranslate nohighlight">\(B_{kl}\)</span> is the probability of an edge from group <span class="math notranslate nohighlight">\(k\)</span> to <span class="math notranslate nohighlight">\(l\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(\tilde{B}\)</span> be a <em>perturbed</em> matrix of probabilities. We are interested in testing
<span class="math notranslate nohighlight">\(H_0: B = \tilde{B}\)</span> vs. <span class="math notranslate nohighlight">\(H_a: ... \neq ...\)</span>. To do so, we compare each
<span class="math notranslate nohighlight">\(H_0: B_{kl} = \tilde{B}_{kl}\)</span> using Fisher’s exact test. This results in p-values for
each <span class="math notranslate nohighlight">\((k,l)\)</span> comparison, <span class="math notranslate nohighlight">\(\{p_{1,1}, p_{1,2}...p_{K,K}\}\)</span>.</p>
<p>Now, we still are after an overall test for the equality <span class="math notranslate nohighlight">\(B = \tilde{B}\)</span>. Thus, we
need a way to combine p-values <span class="math notranslate nohighlight">\(\{p_{1,1}, p_{1,2}...p_{K,K}\}\)</span> to get an <em>overall</em>
p-value for our test comparing the stochastic block model probabilities. One way is
Fisher’s method; another is to take the
minimum p-value out of a collection of p-values which have been corrected for multiple
comparisons (say, via Bonferroni or Holm-Bonferroni).</p>
<p>To compare how these two alternative methods of combining p-values work, we did the
following simulation:</p>
<ul>
<li><p>Let <span class="math notranslate nohighlight">\(t\)</span> be the number of probabilities to perturb.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\delta\)</span> represent the strength of the perturbation (see model below).</p></li>
<li><p>For each trial:</p>
<ul>
<li><p>Randomly select <span class="math notranslate nohighlight">\(t\)</span> probabilities without replacement from the elements of <span class="math notranslate nohighlight">\(B\)</span></p></li>
<li><p>For each of these elements, <span class="math notranslate nohighlight">\(\tilde{B}_{kl} = TN(B_{kl}, \delta B_{kl})\)</span> where
<span class="math notranslate nohighlight">\(TN\)</span> is a truncated normal distribution, such that probabilities don’t end up
outside of [0, 1].</p></li>
<li><p>For each element <em>not</em> perturbed, <span class="math notranslate nohighlight">\(\tilde{B}_{kl} = B_{kl}\)</span></p></li>
<li><p>Sample the number of edges from each block under each model. In other words, let
<span class="math notranslate nohighlight">\(m_{kl}\)</span> be the number of edges in the <span class="math notranslate nohighlight">\((k,l)\)</span>-th block, and let <span class="math notranslate nohighlight">\(n_k, n_l\)</span> be
the number of edges in the <span class="math notranslate nohighlight">\(k\)</span>-th and <span class="math notranslate nohighlight">\(l\)</span>-th blocks, respectively. Then, we have</p>
<div class="math notranslate nohighlight">
\[m_{kl} \sim Binomial(n_k n_l, B_{kl})\]</div>
<p>and likewise but with <span class="math notranslate nohighlight">\(\tilde{B}_{kl}\)</span> for <span class="math notranslate nohighlight">\(\tilde{m}_{kl}\)</span>.</p>
</li>
<li><p>Run Fisher’s exact test to generate a <span class="math notranslate nohighlight">\(p_{kl}\)</span> for each <span class="math notranslate nohighlight">\((k,l)\)</span>.</p></li>
<li><p>Run Fisher’s method for combining p-values, or take the minimum p-value after
Bonferroni correction.</p></li>
</ul>
</li>
<li><p>These trials were repeated for <span class="math notranslate nohighlight">\(\delta \in \{0.1, 0.2, 0.3, 0.4, 0.5\}\)</span> and
<span class="math notranslate nohighlight">\(t \in \{25, 50, 75, 100, 125\}\)</span>. For each <span class="math notranslate nohighlight">\((\delta, t)\)</span> we ran 100 replicates of the
model/test above.</p></li>
</ul>
</div>
<div class="section" id="p-values-under-the-null">
<h2>P-values under the null<a class="headerlink" href="#p-values-under-the-null" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_base</span> <span class="o">=</span> <span class="n">misc</span><span class="p">[</span><span class="s2">&quot;probabilities1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">B_base</span><span class="p">)</span>
<span class="n">base_probs</span> <span class="o">=</span> <span class="n">B_base</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
<span class="n">n_possible_matrix</span> <span class="o">=</span> <span class="n">misc</span><span class="p">[</span><span class="s2">&quot;possible1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">ns</span> <span class="o">=</span> <span class="n">n_possible_matrix</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>

<span class="n">n_null_sims</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">RERUN_NULL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
    <span class="s2">&quot;/Users/bpedigo/JHU_code/bilateral/bilateral-connectome/results/&quot;</span>
    <span class="s2">&quot;outputs/compare_sbm_methods_sim/null_results.csv&quot;</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">RERUN_NULL</span><span class="p">:</span>
    <span class="n">null_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_null_sims</span><span class="p">)):</span>
        <span class="n">base_samples</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">base_probs</span><span class="p">)</span>
        <span class="n">perturb_samples</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">base_probs</span><span class="p">)</span>

        <span class="c1"># test on the new data</span>
        <span class="k">def</span> <span class="nf">tester</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
            <span class="n">stat</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">binom_2samp</span><span class="p">(</span>
                <span class="n">base_samples</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                <span class="n">ns</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                <span class="n">perturb_samples</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                <span class="n">ns</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                <span class="n">null_odds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">pvalue</span>

        <span class="n">pvalue_collection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">tester</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_samples</span><span class="p">)))</span>
        <span class="n">n_overall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)</span>
        <span class="n">pvalue_collection</span> <span class="o">=</span> <span class="n">pvalue_collection</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)]</span>
        <span class="n">n_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)</span>
        <span class="n">n_skipped</span> <span class="o">=</span> <span class="n">n_overall</span> <span class="o">-</span> <span class="n">n_tests</span>

        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sim&quot;</span><span class="p">:</span> <span class="n">sim</span><span class="p">,</span>
            <span class="s2">&quot;n_tests&quot;</span><span class="p">:</span> <span class="n">n_tests</span><span class="p">,</span>
            <span class="s2">&quot;n_skipped&quot;</span><span class="p">:</span> <span class="n">n_skipped</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">]:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                <span class="n">overall_pvalue</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="n">n_tests</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_pvalue</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fisher&quot;</span><span class="p">:</span>
                <span class="n">stat</span><span class="p">,</span> <span class="n">overall_pvalue</span> <span class="o">=</span> <span class="n">combine_pvalues</span><span class="p">(</span>
                    <span class="n">pvalue_collection</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fisher&quot;</span>
                <span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_pvalue</span>

            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
            <span class="n">null_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">null_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">null_rows</span><span class="p">)</span>
    <span class="n">null_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">null_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">giskard.plot</span> <span class="kn">import</span> <span class="n">subuniformity_plot</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">method_null_results</span> <span class="o">=</span> <span class="n">null_results</span><span class="p">[</span><span class="n">null_results</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">method</span><span class="p">]</span>
    <span class="n">subuniformity_plot</span><span class="p">(</span>
        <span class="n">method_null_results</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">],</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">method_palette</span><span class="p">[</span><span class="n">method</span><span class="p">],</span>
        <span class="n">element</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

<span class="n">gluefig</span><span class="p">(</span><span class="s2">&quot;null_distributions&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="figure align-default" id="id1">
<div class="cell_output docutils container">
<img alt="_images/compare_sbm_methods_sim_6_0.png" src="_images/compare_sbm_methods_sim_6_0.png" />
</div>
<p class="caption"><span class="caption-text">Distributions of p-values under the null for Fisher’s method (left) and the Min method
(right) from a simulation with 100 resamples under the null. Dotted line indicates
the CDF of a <span class="math notranslate nohighlight">\(Uniform(0,1)\)</span> random variable. The
p-values in the upper left of each panel is for a 1-sample KS test, where the null is
that the variable is distributed <span class="math notranslate nohighlight">\(Uniform(0,1)\)</span> against the alternative that its CDF
is larger than that of a <span class="math notranslate nohighlight">\(Uniform(0,1)\)</span> random variable (i.e. that it is superuniform).
Note that both methods appear empirically valid, but Fisher’s appears highly conservative.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="p-values-under-the-alternative">
<h2>P-values under the alternative<a class="headerlink" href="#p-values-under-the-alternative" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_sims</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">n_perturb_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">perturb_size_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perturb sizes: </span><span class="si">{</span><span class="n">perturb_size_range</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perturb number range: </span><span class="si">{</span><span class="n">n_perturb_range</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">n_runs</span> <span class="o">=</span> <span class="n">n_sims</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_perturb_range</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">perturb_size_range</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of runs: </span><span class="si">{</span><span class="n">n_runs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Perturb sizes: [0.1 0.2 0.3 0.4 0.5]
Perturb number range: [ 25  50  75 100 125]
Number of runs: 2500
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RERUN_SIM</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
    <span class="s2">&quot;/Users/bpedigo/JHU_code/bilateral/bilateral-connectome/results/&quot;</span>
    <span class="s2">&quot;outputs/compare_sbm_methods_sim/results.csv&quot;</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">RERUN_SIM</span><span class="p">:</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">mean_itertimes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_time_first</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">progress_steps</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">progress_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_progress</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>
    <span class="n">simple_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">example_perturb_probs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">perturb_size</span> <span class="ow">in</span> <span class="n">perturb_size_range</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n_perturb</span> <span class="ow">in</span> <span class="n">n_perturb_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sims</span><span class="p">):</span>
                <span class="n">itertime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># just a way to track progress</span>
                <span class="n">progress_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">progress_prop</span> <span class="o">=</span> <span class="n">progress_counter</span> <span class="o">/</span> <span class="n">n_runs</span>
                <span class="k">if</span> <span class="n">progress_prop</span> <span class="o">-</span> <span class="n">progress_steps</span> <span class="o">&gt;</span> <span class="n">last_progress</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">progress_prop</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">last_progress</span> <span class="o">=</span> <span class="n">progress_prop</span>

                <span class="c1"># choose some elements to perturb</span>
                <span class="n">currtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">perturb_probs</span> <span class="o">=</span> <span class="n">base_probs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">choice_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">perturb_probs</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_perturb</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># pertub em</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">choice_indices</span><span class="p">:</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="n">base_probs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                    <span class="n">new_prob</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">while</span> <span class="n">new_prob</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">new_prob</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">new_prob</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">prob</span> <span class="o">*</span> <span class="n">perturb_size</span><span class="p">)</span>

                    <span class="n">perturb_probs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_prob</span>

                <span class="k">if</span> <span class="n">sim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">example_perturb_probs</span><span class="p">[(</span><span class="n">perturb_size</span><span class="p">,</span> <span class="n">n_perturb</span><span class="p">)]</span> <span class="o">=</span> <span class="n">perturb_probs</span>

                <span class="n">perturb_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">currtime</span>

                <span class="c1"># sample some new binomial data</span>
                <span class="n">currtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="n">base_samples</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">base_probs</span><span class="p">)</span>
                <span class="n">perturb_samples</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">perturb_probs</span><span class="p">)</span>
                <span class="n">sample_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">currtime</span>

                <span class="n">currtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># test on the new data</span>
                <span class="k">def</span> <span class="nf">tester</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
                    <span class="n">stat</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">binom_2samp</span><span class="p">(</span>
                        <span class="n">base_samples</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                        <span class="n">ns</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                        <span class="n">perturb_samples</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                        <span class="n">ns</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span>
                        <span class="n">null_odds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">pvalue</span>

                <span class="n">pvalue_collection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">tester</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_samples</span><span class="p">)))</span>
                <span class="n">pvalue_collection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)</span>
                <span class="n">n_overall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)</span>
                <span class="n">pvalue_collection</span> <span class="o">=</span> <span class="n">pvalue_collection</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)]</span>
                <span class="n">n_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="p">)</span>
                <span class="n">n_skipped</span> <span class="o">=</span> <span class="n">n_overall</span> <span class="o">-</span> <span class="n">n_tests</span>
                <span class="n">test_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">currtime</span>

                <span class="c1"># combine pvalues</span>
                <span class="n">currtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;perturb_size&quot;</span><span class="p">:</span> <span class="n">perturb_size</span><span class="p">,</span>
                    <span class="s2">&quot;n_perturb&quot;</span><span class="p">:</span> <span class="n">n_perturb</span><span class="p">,</span>
                    <span class="s2">&quot;sim&quot;</span><span class="p">:</span> <span class="n">sim</span><span class="p">,</span>
                    <span class="s2">&quot;n_tests&quot;</span><span class="p">:</span> <span class="n">n_tests</span><span class="p">,</span>
                    <span class="s2">&quot;n_skipped&quot;</span><span class="p">:</span> <span class="n">n_skipped</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fisher&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">]:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                        <span class="n">overall_pvalue</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pvalue_collection</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="n">n_tests</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_pvalue</span>
                    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fisher&quot;</span><span class="p">:</span>
                        <span class="n">stat</span><span class="p">,</span> <span class="n">overall_pvalue</span> <span class="o">=</span> <span class="n">combine_pvalues</span><span class="p">(</span>
                            <span class="n">pvalue_collection</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fisher&quot;</span>
                        <span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_pvalue</span>

                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">simple_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                <span class="n">combine_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">currtime</span>

                <span class="k">if</span> <span class="n">progress_counter</span> <span class="o">&lt;</span> <span class="n">n_time_first</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perturb took </span><span class="si">{</span><span class="n">perturb_elapsed</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample took </span><span class="si">{</span><span class="n">sample_elapsed</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test took </span><span class="si">{</span><span class="n">test_elapsed</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combine took </span><span class="si">{</span><span class="n">combine_elapsed</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&quot;</span><span class="p">)</span>
                    <span class="n">iter_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">itertime</span>
                    <span class="n">mean_itertimes</span> <span class="o">+=</span> <span class="n">iter_elapsed</span> <span class="o">/</span> <span class="n">n_time_first</span>
                <span class="k">elif</span> <span class="n">progress_counter</span> <span class="o">==</span> <span class="n">n_time_first</span><span class="p">:</span>
                    <span class="n">projected_time</span> <span class="o">=</span> <span class="n">mean_itertimes</span> <span class="o">*</span> <span class="n">n_runs</span>
                    <span class="n">projected_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">projected_time</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Projected time: </span><span class="si">{</span><span class="n">projected_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

    <span class="n">total_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total experiment took: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">total_elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">simple_rows</span><span class="p">)</span>

    <span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">RERUN_SIM</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">perturb_size_range</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_perturb_range</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">perturb_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perturb_size_range</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">n_perturb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_perturb_range</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">perturb_probs</span> <span class="o">=</span> <span class="n">example_perturb_probs</span><span class="p">[(</span><span class="n">perturb_size</span><span class="p">,</span> <span class="n">n_perturb</span><span class="p">)]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">base_probs</span> <span class="o">!=</span> <span class="n">perturb_probs</span>
            <span class="n">show_base_probs</span> <span class="o">=</span> <span class="n">base_probs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">show_perturb_probs</span> <span class="o">=</span> <span class="n">perturb_probs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">sort_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">show_base_probs</span><span class="p">)</span>
            <span class="n">show_base_probs</span> <span class="o">=</span> <span class="n">show_base_probs</span><span class="p">[</span><span class="n">sort_inds</span><span class="p">]</span>
            <span class="n">show_perturb_probs</span> <span class="o">=</span> <span class="n">show_perturb_probs</span><span class="p">[</span><span class="n">sort_inds</span><span class="p">]</span>

            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">show_base_probs</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">show_perturb_probs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">show_base_probs</span><span class="p">)),</span>
                <span class="n">y</span><span class="o">=</span><span class="n">show_base_probs</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

    <span class="n">gluefig</span><span class="p">(</span><span class="s2">&quot;example-perturbations&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fisher_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fisher&quot;</span><span class="p">]</span>
<span class="n">min_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">]</span>

<span class="n">fisher_means</span> <span class="o">=</span> <span class="n">fisher_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="s2">&quot;n_perturb&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">min_means</span> <span class="o">=</span> <span class="n">min_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="s2">&quot;n_perturb&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">mean_diffs</span> <span class="o">=</span> <span class="n">fisher_means</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_means</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span>
<span class="n">mean_diffs</span> <span class="o">=</span> <span class="n">mean_diffs</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">mean_diffs_square</span> <span class="o">=</span> <span class="n">mean_diffs</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;n_perturb&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;pvalue&quot;</span>
<span class="p">)</span>

<span class="c1"># v = np.max(np.abs(mean_diffs_square.values))</span>

<span class="c1"># fig, ax = plt.subplots(1, 1, figsize=(8, 8))</span>
<span class="c1"># sns.heatmap(</span>
<span class="c1">#     mean_diffs_square,</span>
<span class="c1">#     cmap=&quot;RdBu&quot;,</span>
<span class="c1">#     ax=ax,</span>
<span class="c1">#     yticklabels=perturb_size_range,</span>
<span class="c1">#     xticklabels=n_perturb_range,</span>
<span class="c1">#     square=True,</span>
<span class="c1">#     center=0,</span>
<span class="c1">#     vmin=-v,</span>
<span class="c1">#     vmax=v,</span>
<span class="c1">#     cbar_kws=dict(shrink=0.7),</span>
<span class="c1"># )</span>
<span class="c1"># ax.set(xlabel=&quot;Number of perturbed blocks&quot;, ylabel=&quot;Size of perturbation&quot;)</span>
<span class="c1"># cax = fig.axes[1]</span>
<span class="c1"># cax.text(4, 1, &quot;Min more\nsensitive&quot;, transform=cax.transAxes, va=&quot;top&quot;)</span>
<span class="c1"># cax.text(4, 0, &quot;Fisher more\nsensitive&quot;, transform=cax.transAxes, va=&quot;bottom&quot;)</span>
<span class="c1"># ax.set_title(&quot;(Fisher - Min) pvalues&quot;, fontsize=&quot;x-large&quot;)</span>

<span class="c1"># DISPLAY_FIGS = True</span>
<span class="c1"># gluefig(&quot;pvalue_diff_matrix&quot;, fig)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">perturb_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perturb_size_range</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plot_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">perturb_size</span><span class="p">]</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">plot_results</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;n_perturb&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pvalue&quot;</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="n">method_palette</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">perturb_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-25</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">1e-25</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="mf">0.005</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.005</span><span class="p">),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">),</span>
    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

<span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;p-value&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
<span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Number perturbed&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]]</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Number perturbed&quot;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perturbation size = </span><span class="si">{</span><span class="n">perturb_size_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
<span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Method&quot;</span><span class="p">)</span>

<span class="n">gluefig</span><span class="p">(</span><span class="s2">&quot;perturbation_pvalues_lineplots&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="figure align-default" id="id2">
<div class="cell_output docutils container">
<img alt="_images/compare_sbm_methods_sim_13_0.png" src="_images/compare_sbm_methods_sim_13_0.png" />
</div>
<p class="caption"><span class="caption-text">p-values under the alternative for two different methods for combining p-values:
<a class="reference external" href="https://en.wikipedia.org/wiki/Fisher%27s_method"><strong>Fisher’s method</strong></a> (performed on the
<em>uncorrected</em> p-values) and simply taking
the minimum p-value after <a class="reference external" href="https://en.wikipedia.org/wiki/Bonferroni_correction">Bonferroni correction</a> (here, called <strong>Min</strong>).
The alternative is specified by changing the number of probabilities which are perturbed
(x-axis in each panel) as well as the size of the perturbations which are done
to each probability (panels show increasing perturbation size). Dotted and dashed
lines indicate significance thresholds for <span class="math notranslate nohighlight">\(\alpha = \{0.05, 0.005\}\)</span>, respectively.
Note that in this simulation, even for large numbers of small perturbations (i.e. upper
left panel), the Min method has smaller p-values. Fisher’s method displays smaller p-values
than Min only when there are many (&gt;50) large perturbations, but by this point both
methods yield extremely small p-values.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="power-under-the-alternative">
<h2>Power under the alternative<a class="headerlink" href="#power-under-the-alternative" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">results</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">results</span><span class="p">[(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fisher_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fisher&quot;</span><span class="p">]</span>
<span class="n">min_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">]</span>

<span class="n">fisher_means</span> <span class="o">=</span> <span class="n">fisher_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="s2">&quot;n_perturb&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">min_means</span> <span class="o">=</span> <span class="n">min_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="s2">&quot;n_perturb&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">fisher_power_square</span> <span class="o">=</span> <span class="n">fisher_means</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;n_perturb&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;detected&quot;</span>
<span class="p">)</span>
<span class="n">min_power_square</span> <span class="o">=</span> <span class="n">min_means</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;n_perturb&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;detected&quot;</span>
<span class="p">)</span>

<span class="n">mean_diffs</span> <span class="o">=</span> <span class="n">fisher_means</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">min_means</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span>

<span class="n">mean_diffs</span> <span class="o">=</span> <span class="n">mean_diffs</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">ratios_square</span> <span class="o">=</span> <span class="n">mean_diffs</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;perturb_size&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;n_perturb&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;detected&quot;</span>
<span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_diffs_square</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

<span class="c1"># fig, axs = plt.subplots(1, 3, figsize=(12, 4), sharex=True, sharey=True)</span>
<span class="kn">from</span> <span class="nn">matplotlib.transforms</span> <span class="kn">import</span> <span class="n">Bbox</span>

<span class="n">set_theme</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="c1"># set up plot</span>
<span class="n">pad</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">width_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.3</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">),</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">fisher_col</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">min_col</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">ratio_col</span> <span class="o">=</span> <span class="mi">6</span>


<span class="k">def</span> <span class="nf">shrink_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">ymax</span> <span class="o">+</span> <span class="n">pos</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">pos</span><span class="o">.</span><span class="n">ymin</span>
    <span class="n">new_pos</span> <span class="o">=</span> <span class="n">Bbox</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">height</span><span class="p">],</span>
            <span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">height</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">new_pos</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">power_heatmap</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">yticklabels</span><span class="o">=</span><span class="n">perturb_size_range</span><span class="p">,</span>
        <span class="n">xticklabels</span><span class="o">=</span><span class="n">n_perturb_range</span><span class="p">,</span>
        <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">cbar_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">),</span>
        <span class="n">cbar</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">fisher_col</span><span class="p">]</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">power_heatmap</span><span class="p">(</span><span class="n">fisher_power_square</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fisher&#39;s method&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">shrink_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">im</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ticklocation</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Power</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;($\alpha=0.05$)&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">min_col</span><span class="p">]</span>
<span class="n">power_heatmap</span><span class="p">(</span><span class="n">min_power_square</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Min method&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>

<span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">diverging_palette</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ratio_col</span><span class="p">]</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">power_heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ratios_square</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">pal</span><span class="p">)</span>
<span class="c1"># ax.set_title(r&#39;$log_10(\frac{\text{Power}_{Fisher}}{\text{Power}_{Min}})$&#39;)</span>
<span class="c1"># ax.set_title(</span>
<span class="c1">#     r&quot;$log_{10}($Fisher power$)$&quot; + &quot;\n&quot; + r&quot; - $log_{10}($Min power$)$&quot;,</span>
<span class="c1">#     fontsize=&quot;large&quot;,</span>
<span class="c1"># )</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">shrink_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">im</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ticklocation</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Fisher more</span><span class="se">\n</span><span class="s2">sensitive&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Equal power&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Min more</span><span class="se">\n</span><span class="s2">sensitive&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Log10</span><span class="se">\n</span><span class="s2">power</span><span class="se">\n</span><span class="s2">ratio&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># remove dummy axes</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">has_data</span><span class="p">():</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;# perturbed blocks $\rightarrow$&quot;</span>
<span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Perturbation size $\rightarrow$&quot;</span>
<span class="n">axs</span><span class="p">[</span><span class="n">fisher_col</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="n">min_col</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="n">ratio_col</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">,</span> <span class="s2">&quot;A)&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.64</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">,</span> <span class="s2">&quot;B)&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">gluefig</span><span class="p">(</span><span class="s2">&quot;relative_power&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="figure align-default" id="id3">
<div class="cell_output docutils container">
<img alt="_images/compare_sbm_methods_sim_17_0.png" src="_images/compare_sbm_methods_sim_17_0.png" />
</div>
<p class="caption"><span class="caption-text">Comparison of power for Fisher’s and the Min method. <strong>A)</strong> The power under the
alternative described in the text for both Fisher’s method and the Min method. In both
heatmaps, the x-axis represents an increasing number of blocks which are perturbed,
and the y-axis represents an increasing magnitude for each perturbation. <strong>B)</strong> The
log of the ratio of powers (Fisher’s / Min) for each alternative. Note that positive
(purple) values would represent that Fisher’s is more powerful, and negative (green)
represent that the Min method is more powerful. Notice that the Min method appears
to have more power for subtler (fewer or smaller perturbations) alternatives, and
nearly equal power for more obvious alternatives.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Benjamin D. Pedigo<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>