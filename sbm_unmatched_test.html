
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Group connection test &#8212; Bilateral Connectome</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="_static/nd_logo_small.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Density-adjusted group connection test" href="adjusted_sbm_unmatched_test.html" />
    <link rel="prev" title="Density test" href="er_unmatched_test.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/nd_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Bilateral Connectome</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="abstract.html">
                    Abstract
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Preliminaries
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="outline.html">
   Outline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="unmatched_vs_matched.html">
   Unmatched vs. matched networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="define_data.html">
   Larval
   <em>
    Drosophila melanogaster
   </em>
   brain connectome
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="show_data.html">
   Visualize the connectome
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tests for bilateral symmetry
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="er_unmatched_test.html">
   Density test
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Group connection test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="adjusted_sbm_unmatched_test.html">
   Density-adjusted group connection test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kc_minus.html">
   Removing the Kenyon cells
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="thresholding_tests.html">
   Comparing edge weight thresholds
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="revamp_sbm_methods_sim.html">
   Comparing methods for SBM testing
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="references.html">
   References
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Slides
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/berlin.pdf">
   Berlin Connectomics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/drexel.pdf">
   Drexel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/lab-meeting-2022-02-24.pdf">
   Lab meeting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/nmc-4.0.pdf">
   neuromatch 4.0
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/nn2-data-blitz.pdf">
   NN2 Data Blitz
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/princeton.pdf">
   Princeton
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Posters
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.neurodata.io/bilateral-connectome/naisys-2022.pdf">
   NAISys
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Errata
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="ad.html">
   Further info
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nhypergeom_sims.html">
   An exact test for non-unity null odds ratios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rdpg_unmatched_test.html">
   An embedding-based test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="er_matched_test.html">
   A density-based test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sbm_matched_test.html">
   A group-based test
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/neurodata/bilateral-connectome"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/neurodata/bilateral-connectome/issues/new?title=Issue%20on%20page%20%2Fsbm_unmatched_test.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/sbm_unmatched_test.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-stochastic-block-model-sbm">
   The stochastic block model (SBM)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-under-the-sbm-model">
   Testing under the SBM model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adjusting-for-a-difference-in-density">
   Adjusting for a difference in density
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#end">
   End
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Group connection test</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-stochastic-block-model-sbm">
   The stochastic block model (SBM)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-under-the-sbm-model">
   Testing under the SBM model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adjusting-for-a-difference-in-density">
   Adjusting for a difference in density
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#end">
   End
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="group-connection-test">
<h1>Group connection test<a class="headerlink" href="#group-connection-test" title="Permalink to this headline">#</a></h1>
<p>Next, we test bilateral symmetry by making an assumption that the left and the right
hemispheres both come from a stochastic block model, which models the probability
of any potential edge as a function of the groups that the source and target nodes
are part of.</p>
<p>For now, we use some broad cell type categorizations for each neuron to determine its
group. Alternatively, there are many methods for <em>estimating</em> these assignments to
groups for each neuron, which we do not explore here.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import datetime
import time

import matplotlib as mpl
import matplotlib.pyplot as plt
import matplotlib.transforms as mtrans
import numpy as np
import pandas as pd
import seaborn as sns
from giskard.plot import merge_axes, rotate_labels, soft_axis_off
from graspologic.simulations import sbm
from matplotlib.font_manager import FontProperties
from matplotlib.patches import PathPatch
from matplotlib.text import TextPath
from pkg.data import load_network_palette, load_node_palette, load_unmatched
from pkg.io import FIG_PATH, get_environment_variables
from pkg.io import glue as default_glue
from pkg.io import savefig
from pkg.plot import (
    SmartSVG,
    draw_hypothesis_box,
    heatmap_grouped,
    make_sequential_colormap,
    networkplot_simple,
    plot_pvalues,
    plot_stochastic_block_probabilities,
    rainbowarrow,
    set_theme,
)
from pkg.stats import stochastic_block_test
from pkg.utils import get_toy_palette, sample_toy_networks
from seaborn.utils import relative_luminance
from svgutils.compose import Figure, Panel, Text


_, _, DISPLAY_FIGS = get_environment_variables()

FILENAME = &quot;sbm_unmatched_test&quot;

FIG_PATH = FIG_PATH / FILENAME


def glue(name, var, **kwargs):
    default_glue(name, var, FILENAME, **kwargs)


def gluefig(name, fig, **kwargs):
    savefig(name, foldername=FILENAME, **kwargs)

    glue(name, fig, figure=True)

    if not DISPLAY_FIGS:
        plt.close()


t0 = time.time()
set_theme()
rng = np.random.default_rng(8888)

network_palette, NETWORK_KEY = load_network_palette()
node_palette, NODE_KEY = load_node_palette()
neutral_color = sns.color_palette(&quot;Set2&quot;)[2]

GROUP_KEY = &quot;celltype_discrete&quot;

left_adj, left_nodes = load_unmatched(side=&quot;left&quot;)
right_adj, right_nodes = load_unmatched(side=&quot;right&quot;)

left_labels = left_nodes[GROUP_KEY].values
right_labels = right_nodes[GROUP_KEY].values
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Environment variables:
   RESAVE_DATA: true
   RERUN_SIMS: true
   DISPLAY_FIGS: False
</pre></div>
</div>
</div>
</div>
<section id="the-stochastic-block-model-sbm">
<h2>The stochastic block model (SBM)<a class="headerlink" href="#the-stochastic-block-model-sbm" title="Permalink to this headline">#</a></h2>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Stochastic_block_model"><strong>stochastic block model (SBM)</strong>
</a>
is a popular statistical model of networks. Put simply, this model treats the
probability of an edge occuring between node <span class="math notranslate nohighlight">\(i\)</span> and node <span class="math notranslate nohighlight">\(j\)</span> as purely a function of
the <em>communities</em> or <em>groups</em> that node <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> belong to. Therefore, this model
is parameterized by:</p>
<ol class="simple">
<li><p>An assignment of each node in the network to a group. Note that this assignment
can be considered to be deterministic or random, depending on the specific
framing of the model one wants to use.</p></li>
<li><p>A set of group-to-group connection probabilities</p></li>
</ol>
<div class="admonition-math admonition">
<p class="admonition-title">Math</p>
<p>Let <span class="math notranslate nohighlight">\(n\)</span> be the number of nodes, and <span class="math notranslate nohighlight">\(K\)</span> be the number of groups in an SBM. For a
network <span class="math notranslate nohighlight">\(A\)</span> sampled from an SBM:</p>
<div class="math notranslate nohighlight">
\[ A \sim SBM(B, \tau)\]</div>
<p>We say that for all <span class="math notranslate nohighlight">\((i,j), i \neq j\)</span>, with <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> both running
from <span class="math notranslate nohighlight">\(1 ... n\)</span> the probability of edge <span class="math notranslate nohighlight">\((i,j)\)</span> occuring is:</p>
<div class="math notranslate nohighlight">
\[ P[A_{ij} = 1] = P_{ij} = B_{\tau_i, \tau_j} \]</div>
<p>where <span class="math notranslate nohighlight">\(B \in [0,1]^{K \times K}\)</span> is a matrix of group-to-group connection
probabilities and <span class="math notranslate nohighlight">\(\tau \in \{1...K\}^n\)</span> is a vector of node-to-group assignments.
Note that here we are assuming <span class="math notranslate nohighlight">\(\tau\)</span> is a fixed vector of assignments, though other
formuations of the SBM allow these assignments to themselves come from a categorical
distribution.</p>
</div>
</section>
<section id="testing-under-the-sbm-model">
<h2>Testing under the SBM model<a class="headerlink" href="#testing-under-the-sbm-model" title="Permalink to this headline">#</a></h2>
<p>Assuming this model, there are a few ways that one could test for differences between
two networks. In our case, we are interested in comparing the group-to-group
connection probability matrices, <span class="math notranslate nohighlight">\(B\)</span>,  for the left and right hemispheres.</p>
<div class="admonition-math admonition">
<p class="admonition-title">Math</p>
<p>We are interested in testing:</p>
<div class="math notranslate nohighlight" id="equation-sbm-unmatched-null">
<span class="eqno">(1)<a class="headerlink" href="#equation-sbm-unmatched-null" title="Permalink to this equation">#</a></span>\[H_0: B^{(L)} = B^{(R)}, \quad H_A: B^{(L)} \neq B^{(R)}\]</div>
</div>
<p>Rather than having to compare one proportion as in <a class="reference internal" href="er_unmatched_test.html"><span class="doc std std-doc">Density test</span></a>, we are
now interedted in comparing all <span class="math notranslate nohighlight">\(K^2\)</span> probabilities between the SBM models for the
left and right hemispheres.</p>
<div class="admonition-math admonition">
<p class="admonition-title">Math</p>
<p>The hypothesis test above can be decomposed into <span class="math notranslate nohighlight">\(K^2\)</span> indpendent hypotheses.
<span class="math notranslate nohighlight">\(B^{(L)}\)</span>
and <span class="math notranslate nohighlight">\(B^{(R)}\)</span> are both <span class="math notranslate nohighlight">\(K \times K\)</span> matrices, where each element <span class="math notranslate nohighlight">\(b_{kl}\)</span> represents
the probability of a connection from a neuron in group <span class="math notranslate nohighlight">\(k\)</span> to one in group <span class="math notranslate nohighlight">\(l\)</span>. We
also know that group <span class="math notranslate nohighlight">\(k\)</span> for the left network corresponds with group <span class="math notranslate nohighlight">\(k\)</span> for the
right. In other words, the <em>groups</em> are matched. Thus, we are interested in testing,
for <span class="math notranslate nohighlight">\(k, l\)</span> both running from <span class="math notranslate nohighlight">\(1...K\)</span>:</p>
<div class="math notranslate nohighlight">
\[ H_0: B_{kl}^{(L)} = B_{kl}^{(R)},
\quad H_A: B_{kl}^{(L)} \neq B_{kl}^{(R)}\]</div>
</div>
<p>Thus, we will use
<a class="reference external" href="https://en.wikipedia.org/wiki/Fisher%27s_exact_test">Fisher’s exact test</a> to
compare each set of probabilities. To combine these multiple hypotheses into one, we
will use <a class="reference external" href="https://en.wikipedia.org/wiki/Fisher%27s_method">Fisher’s method</a> for
combining p-values to give us a p-value for the overall test. We also can look at
the p-values for each of the individual tests after correction for multiple
comparisons by the
<a class="reference external" href="https://en.wikipedia.org/wiki/Holm%E2%80%93Bonferroni_method">Bonferroni-Holm method.
</a></p>
<p>For the current investigation, we focus on the case where <span class="math notranslate nohighlight">\(\tau\)</span> is known ahead of
time, sometimes called the <strong>A priori SBM</strong>. We use some broad cell type labels which
were described in the paper which published the data to
define the group assignments <span class="math notranslate nohighlight">\(\tau\)</span>. Here, we do not explore
estimating these assignments, though many techniques exist for doing so. We note that
the results presented here could change depending on the group assignments which are
used. We also do not consider tests which would compare the assignment vectors,
<span class="math notranslate nohighlight">\(\tau\)</span>. <a class="reference internal" href="#fig-sbm-unmatched-test-group-counts"><span class="std std-numref">Figure 4</span></a> shows the
number of neurons in each group in the group assignments <span class="math notranslate nohighlight">\(\tau\)</span> for the left and
the right hemispheres. The number of neurons in each group is quite similar between
the two hemispheres.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>

np.random.seed(8888)
ps = [0.2, 0.4, 0.6]
n_steps = len(ps)
fig, axs = plt.subplots(
    3,
    n_steps,
    figsize=(6, 4),
    gridspec_kw=dict(height_ratios=[2, 2, 1], wspace=0),
    constrained_layout=True,
)


ns = [5, 6, 7]
B = np.array([[0.8, 0.2, 0.05], [0.05, 0.9, 0.2], [0.05, 0.05, 0.7]])
palette = get_toy_palette()


def label_matrix_element(
    matrix,
    row_ind,
    col_ind,
    label,
    ax,
    pad=0.02,
    fontsize=&quot;small&quot;,
    cmap=None,
    color=None,
    linewidth=2,
):
    xlow = col_ind + pad
    xhigh = col_ind + 1 - pad
    ylow = row_ind + pad
    yhigh = row_ind + 1 - pad
    ax.plot(
        [xlow, xhigh, xhigh, xlow, xlow],
        [yhigh, yhigh, ylow, ylow, yhigh],
        zorder=100,
        color=&quot;red&quot;,
        clip_on=False,
        linewidth=linewidth,
    )

    if color is None:
        if cmap is None:
            cmap = make_sequential_colormap(&quot;Blues&quot;, 0, 1)

        color = cmap(matrix[row_ind, col_ind])
        lum = relative_luminance(color)
        text_color = &quot;.15&quot; if lum &gt; 0.408 else &quot;w&quot;
    else:
        text_color = color

    ax.text(
        col_ind + 0.5,
        row_ind + 0.5,
        label,
        ha=&quot;center&quot;,
        va=&quot;center&quot;,
        fontsize=fontsize,
        color=text_color,
    )


for i, p in enumerate(ps):
    B_mod = B.copy()
    B_mod[0, 1] = p
    seed = 8
    np.random.seed(seed)
    A, labels = sbm(ns, B_mod, directed=True, loops=False, return_labels=True)
    if i == 0:
        node_data = pd.DataFrame(index=np.arange(A.shape[0]))
        node_data[&quot;labels&quot;] = labels + 1

    ax = axs[0, i]
    networkplot_simple(
        A, node_data, ax=ax, compute_layout=i == 0, palette=palette, group=True
    )
    ax.axis(&quot;square&quot;)
    ax.set(xticks=[], yticks=[], ylabel=&quot;&quot;, xlabel=&quot;&quot;)

    label_text = f&quot;{p}&quot;
    if i == 0:
        label_text = r&quot;$B_{12} = $&quot; + label_text
    ax.set_title(label_text)

    ax = axs[1, i]
    heatmap_grouped(B_mod, [1, 2, 3], palette=palette, ax=ax)
    label_matrix_element(B_mod, 0, 1, r&quot;$B_{12}$&quot;, ax)


axs[0, 0].set_ylabel(&quot;Network&quot;, rotation=0, ha=&quot;right&quot;, labelpad=5)
axs[1, 0].set_ylabel(
    &quot;Connection\nprobabilities\n&quot; + r&quot;($B$)&quot;,
    rotation=0,
    ha=&quot;right&quot;,
    va=&quot;center&quot;,
    labelpad=10,
)


ax = merge_axes(fig, axs, rows=2)


soft_axis_off(ax)
ax.set(xticks=[], yticks=[])

rainbowarrow(ax, (0.1, 0.5), (0.89, 0.5), cmap=&quot;Blues&quot;, lw=12)
ax.set_xlim((0, 1))
ax.set_ylim((0, 1))
ax.set_xlabel(r&quot;Increasing $1 \rightarrow 2$ connection probability&quot;)

fig.set_facecolor(&quot;w&quot;)

gluefig(&quot;sbm_explain&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>

fig, axs = plt.subplots(
    4,
    7,
    figsize=(14, 6),
    gridspec_kw=dict(
        wspace=0,
        hspace=0,
        height_ratios=[1.5, 5, 2.5, 5],
        width_ratios=[5, 2, 5, 2, 5, 1.5, 5],
    ),
    constrained_layout=False,
)

axs[0, 0].set_title(&quot;Group neurons&quot;, fontsize=&quot;medium&quot;)
axs[0, 2].set_title(&quot;Estimate group\nconnection probabilities&quot;, x=0.45, ha=&quot;center&quot;)
axs[0, 4].set_title(&quot;Compare probabilities,\ncompute p-values&quot;, fontsize=&quot;medium&quot;)
axs[0, 6].set_title(&quot;Combine p-values\nfor overall test&quot;, fontsize=&quot;medium&quot;)


A1, A2, node_data = sample_toy_networks()
palette = get_toy_palette()


ax = axs[1, 0]
networkplot_simple(A1, node_data, palette=palette, ax=ax, group=True)
ax.set_ylabel(
    &quot;Left&quot;,
    color=network_palette[&quot;Left&quot;],
    size=&quot;large&quot;,
    rotation=0,
    ha=&quot;right&quot;,
    labelpad=10,
)

ax = axs[3, 0]
networkplot_simple(A2, node_data, palette=palette, ax=ax, group=True)
ax.set_ylabel(
    &quot;Right&quot;,
    color=network_palette[&quot;Right&quot;],
    size=&quot;large&quot;,
    rotation=0,
    ha=&quot;right&quot;,
    labelpad=10,
)

ax = merge_axes(fig, axs, rows=None, cols=1)
ax.axis(&quot;off&quot;)
ax.plot([0.5, 0.5], [0, 1], color=&quot;lightgrey&quot;, linewidth=1.5)
ax.set_xlim((0, 1))

ax = axs[1, 2]
_, _, misc = stochastic_block_test(A1, A1, node_data[&quot;labels&quot;], node_data[&quot;labels&quot;])
Bhat1 = misc[&quot;probabilities1&quot;].values
top_ax, left_ax = heatmap_grouped(
    Bhat1,
    [1, 2, 3],
    palette=palette,
    ax=ax,
)
top_ax.set_title(r&quot;$\hat{B}^{(L)}$&quot;, color=network_palette[&quot;Left&quot;])
left_ax.set_ylabel(&quot;Source group&quot;, fontsize=&quot;small&quot;)
ax.set_xlabel(&quot;Target group&quot;, fontsize=&quot;small&quot;)

label_matrix_element(Bhat1, 0, 1, r&quot;$\hat{B}_{12}^{(L)}$&quot;, ax)


ax = axs[3, 2]
_, _, misc = stochastic_block_test(A2, A2, node_data[&quot;labels&quot;], node_data[&quot;labels&quot;])
Bhat2 = misc[&quot;probabilities1&quot;].values
top_ax, left_ax = heatmap_grouped(Bhat2, [1, 2, 3], palette=palette, ax=ax)
top_ax.set_title(r&quot;$\hat{B}^{(R)}$&quot;, color=network_palette[&quot;Right&quot;])
left_ax.set_ylabel(&quot;Source group&quot;, fontsize=&quot;small&quot;)
ax.set_xlabel(&quot;Target group&quot;, fontsize=&quot;small&quot;)
label_matrix_element(Bhat2, 0, 1, r&quot;$\hat{B}_{12}^{(R)}$&quot;, ax)

# divider
ax = merge_axes(fig, axs, rows=None, cols=3)
ax.axis(&quot;off&quot;)
ax.plot([0.3, 0.3], [0, 1], color=&quot;lightgrey&quot;, linewidth=1.5, clip_on=False)
ax.set_xlim((0, 1))

# 3rd column
ax = merge_axes(fig, axs, rows=(1, 4), cols=4)


linestyle_kws = dict(linewidth=1, color=&quot;dimgrey&quot;)
xmin = 0.01
xmax = 0.99
ymax = 0.95
ymin = 0.65
ax.plot([xmin, xmax, xmax, xmin, xmin], [ymax, ymax, ymin, ymin, ymax], **linestyle_kws)

xstart = -0.05

ax.text(
    xstart - 0.05,
    0.9,
    r&quot;$\hat{B}^{(L)}_{ij}$&quot;,
    ha=&quot;center&quot;,
    va=&quot;center&quot;,
    color=network_palette[&quot;Left&quot;],
)

ax.text(
    xstart - 0.05,
    0.7,
    r&quot;$\hat{B}^{(R)}_{ij}$&quot;,
    ha=&quot;center&quot;,
    va=&quot;center&quot;,
    color=network_palette[&quot;Right&quot;],
)


def compare_probability_column(i, j, x, Bhat1, Bhat2, ax=None, palette=None):
    cmap = make_sequential_colormap(&quot;Blues&quot;)

    prob1 = Bhat1[i, j]
    prob2 = Bhat2[i, j]

    ystart = 1.07
    ax.plot(
        [x],
        [ystart],
        &quot;o&quot;,
        markersize=9,
        markeredgecolor=&quot;black&quot;,
        markeredgewidth=1,
        markerfacecolor=palette[i + 1],
        clip_on=False,
    )
    ax.plot(
        [x],
        [ystart - 0.08],
        &quot;o&quot;,
        markersize=9,
        markeredgecolor=&quot;black&quot;,
        markeredgewidth=1,
        markerfacecolor=palette[j + 1],
        clip_on=False,
    )
    ax.annotate(
        &quot;&quot;,
        xy=(x, ystart - 0.08),
        xytext=(x, ystart),
        arrowprops=dict(
            arrowstyle=&quot;-|&gt;&quot;,
            facecolor=&quot;black&quot;,
            shrinkA=5,
            shrinkB=4,
        ),
        clip_on=False,
        zorder=-1,
        fontsize=10,
    )

    ax.plot([x], [0.9], &quot;s&quot;, markersize=15, color=cmap(prob1))
    ax.plot([x], [0.7], &quot;s&quot;, markersize=15, color=cmap(prob2))
    ax.text(x, 0.78, r&quot;$\overset{?}{=}$&quot;, fontsize=&quot;large&quot;, va=&quot;center&quot;, ha=&quot;center&quot;)

    ax.annotate(
        &quot;&quot;,
        xy=(x, 0.53),
        xytext=(x, 0.63),
        arrowprops=dict(
            arrowstyle=&quot;-|&gt;&quot;,
            facecolor=&quot;black&quot;,
        ),
    )

    p_text = r&quot;$p_{&quot;
    p_text += str(i + 1)
    p_text += str(j + 1)
    p_text += r&quot;}$&quot;
    ax.text(x, 0.47, p_text, fontsize=&quot;small&quot;, va=&quot;center&quot;, ha=&quot;center&quot;)
    ax.set(xticks=[], yticks=[])


compare_probability_column(0, 0, xstart + 0.15, Bhat1, Bhat2, ax=ax, palette=palette)
compare_probability_column(0, 1, xstart + 0.35, Bhat1, Bhat2, ax=ax, palette=palette)

ax.plot(
    [0.44], [0.78], &quot;.&quot;, markersize=4, markeredgecolor=&quot;black&quot;, markerfacecolor=&quot;black&quot;
)
ax.plot(
    [0.5], [0.78], &quot;.&quot;, markersize=4, markeredgecolor=&quot;black&quot;, markerfacecolor=&quot;black&quot;
)
ax.plot(
    [0.56], [0.78], &quot;.&quot;, markersize=4, markeredgecolor=&quot;black&quot;, markerfacecolor=&quot;black&quot;
)

compare_probability_column(2, 1, xstart + 0.75, Bhat1, Bhat2, ax=ax, palette=palette)
compare_probability_column(2, 2, xstart + 0.95, Bhat1, Bhat2, ax=ax, palette=palette)

xmin = 0.21
xmax = 0.39
ymax = 1.1
ymin = 0.4
ax.plot(
    [xmin, xmax, xmax, xmin, xmin],
    [ymax, ymax, ymin, ymin, ymax],
    color=&quot;red&quot;,
    clip_on=False,
    lw=1.5,
)

ax.set(xlim=(0, 1), ylim=(0, 1))


draw_hypothesis_box(
    &quot;sbm&quot;, xstart + 0.1, 0.2, yskip=0.12, ax=ax, subscript=True, xpad=0.05, ypad=0.0075
)

ax.axis(&quot;off&quot;)

# divider
ax = merge_axes(fig, axs, rows=None, cols=5)
ax.axis(&quot;off&quot;)
ax.plot([0.65, 0.65], [0, 1], color=&quot;lightgrey&quot;, linewidth=1.5, clip_on=False)
ax.set_xlim((0, 1))

# last column
ax = axs[1, 6]
uncorrected_pvalues = np.array([[0.5, 0.1, 0.22], [0.2, 0.01, 0.86], [0.43, 0.2, 0.6]])
top_ax, left_ax = heatmap_grouped(
    uncorrected_pvalues,
    labels=[1, 2, 3],
    vmin=None,
    vmax=None,
    ax=ax,
    palette=palette,
    cmap=&quot;RdBu&quot;,
    center=1,
)
left_ax.set_ylabel(&quot;Source group&quot;, fontsize=&quot;small&quot;)
ax.set_xlabel(&quot;Target group&quot;, fontsize=&quot;small&quot;)
top_ax.set_title(&quot;p-values&quot;)

label_matrix_element(uncorrected_pvalues, 0, 1, r&quot;$p_{12}$&quot;, ax, color=&quot;w&quot;)


ax = merge_axes(fig, axs, rows=(2, 4), cols=6)

# REF: https://stackoverflow.com/questions/50039667/matplotlib-scale-text-curly-brackets

x = 0.35
y = 0.9

trans = mtrans.Affine2D().rotate_deg_around(x, y, -90) + ax.transData
fp = FontProperties(weight=&quot;ultralight&quot;, stretch=&quot;ultra-condensed&quot;)
tp = TextPath((x, y), &quot;$\}$&quot;, size=0.7, prop=fp, usetex=True)
pp = PathPatch(tp, lw=0, fc=&quot;k&quot;, transform=trans)
ax.add_artist(pp)
ax.set(xlim=(0, 1), ylim=(0, 1))


draw_hypothesis_box(&quot;sbm&quot;, 0.05, 0.4, yskip=0.15, ypad=0.02, ax=ax)

ax.axis(&quot;off&quot;)

for ax in axs.flat:
    if not ax.has_data():
        ax.axis(&quot;off&quot;)

fig.set_facecolor(&quot;w&quot;)
gluefig(&quot;sbm_methods_explain&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
set_theme(font_scale=1)

fig, axs = plt.subplots(
    1,
    2,
    figsize=(6, 3),
    gridspec_kw=dict(
        wspace=0.3,
    ),
    constrained_layout=True,
)

ax = axs[0]
node_data = networkplot_simple(A1, node_data, palette=palette, ax=ax, group=True)
centroids = node_data.groupby(&quot;labels&quot;).mean()
ax.annotate(
    &quot;&quot;,
    xy=centroids.loc[2],
    xytext=centroids.loc[1],
    arrowprops=dict(arrowstyle=&quot;-|&gt;&quot;, linewidth=4, color=&quot;red&quot;),
)
ax.set_title(&quot;Group neurons&quot;, pad=10)
ax.autoscale(False)
ax.plot([1.15, 1.15], [-1, 1], color=&quot;lightgrey&quot;, linewidth=1.5, clip_on=False)

ax = axs[1]
top_ax, left_ax = heatmap_grouped(
    Bhat1,
    [1, 2, 3],
    palette=palette,
    ax=ax,
    xlabel_loc=&quot;top&quot;,
)
top_ax.set_title(
    &quot;Estimate group-to-group\nconnection probabilities &quot; + r&quot;($\hat{B}$)&quot;, pad=10
)
left_ax.set_ylabel(&quot;Source group&quot;, fontsize=&quot;medium&quot;)
ax.set_xlabel(&quot;Target group&quot;, fontsize=&quot;medium&quot;)

label_matrix_element(
    Bhat1,
    0,
    1,
    r&quot;$\hat{B}_{12}$&quot;,
    ax,
    fontsize=&quot;medium&quot;,
    pad=0.03,
    linewidth=3,
)

fig.set_facecolor(&quot;w&quot;)

gluefig(&quot;sbm_simple_methods&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
stat, pvalue, misc = stochastic_block_test(
    left_adj,
    right_adj,
    labels1=left_labels,
    labels2=right_labels,
)
glue(&quot;pvalue&quot;, pvalue, form=&quot;pvalue&quot;)
n_tests = misc[&quot;n_tests&quot;]
glue(&quot;n_tests&quot;, n_tests)
print(pvalue)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.573813232327992e-08
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>

def get_significant_pairs(df):
    row_indices, col_indices = np.nonzero(df.values)
    row_indices = df.index[row_indices]
    col_indices = df.columns[col_indices]
    return list(zip(row_indices, col_indices))


significant_pairs = get_significant_pairs(misc[&quot;rejections&quot;])

n_significant_pairs = len(significant_pairs)
glue(&quot;n_significant_pairs&quot;, n_significant_pairs, form=&#39;intword&#39;)

print(&#39;Significant pairs:\n&#39;, significant_pairs)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Significant pairs:
 [(&#39;KCs&#39;, &#39;KCs&#39;), (&#39;LHNs&#39;, &#39;other&#39;), (&#39;PNs&#39;, &#39;LHNs&#39;), (&#39;PNs-somato&#39;, &#39;PNs-somato&#39;), (&#39;other&#39;, &#39;LHNs&#39;), (&#39;other&#39;, &#39;other&#39;)]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
set_theme(font_scale=1)


def melt(misc, names):
    # TODO should be a better way with melt?

    if isinstance(names, str):
        names = [names]
    df = misc[names[0]]
    row_inds, col_inds = np.indices(df.shape)
    row_inds = row_inds.ravel()
    col_inds = col_inds.ravel()
    row_index = df.index[row_inds].to_series().reset_index(drop=True)
    col_index = df.index[col_inds].to_series().reset_index(drop=True)
    col_index.name = &quot;target&quot;
    series_list = [row_index, col_index]
    for name in names:
        df = misc[name]
        values = pd.Series(df.values.ravel(), name=name)
        series_list.append(values)
    melted_df = pd.concat(series_list, axis=1)
    return melted_df


melted_df = melt(
    misc,
    [
        &quot;probabilities1&quot;,
        &quot;probabilities2&quot;,
        &quot;possible1&quot;,
        &quot;possible2&quot;,
        &quot;uncorrected_pvalues&quot;,
    ],
)
melted_df[&quot;Sample size&quot;] = melted_df[&quot;possible1&quot;] + melted_df[&quot;possible2&quot;]
melted_df[&quot;log10(p-value)&quot;] = np.log10(melted_df[&quot;uncorrected_pvalues&quot;])

melted_df = melted_df[~melted_df[&quot;log10(p-value)&quot;].isna()]


vmax = 0
vmin = melted_df[&quot;log10(p-value)&quot;].min()
center = 0
cmap = mpl.cm.get_cmap(&quot;RdBu&quot;)
vrange = max(vmax - center, center - vmin)
normlize = mpl.colors.Normalize(center - vrange, center + vrange)
cmin, cmax = normlize([vmin, vmax])
cc = np.linspace(cmin, cmax, 256)
cmap = mpl.colors.ListedColormap(cmap(cc))

hb_thresh = 0.05 / misc[&quot;n_tests&quot;]
significant = misc[&quot;uncorrected_pvalues&quot;] &lt; hb_thresh
row_inds, col_inds = np.nonzero(significant.values)
row_index = significant.index[row_inds]
col_index = significant.columns[col_inds]
sig_df = melted_df.set_index([&quot;source&quot;, &quot;target&quot;]).loc[zip(row_index, col_index)]

fig, axs = plt.subplots(1, 2, figsize=(16, 8))

ax = axs[0]
sns.scatterplot(
    data=melted_df,
    x=&quot;probabilities2&quot;,
    y=&quot;probabilities1&quot;,
    size=&quot;Sample size&quot;,
    hue=&quot;log10(p-value)&quot;,
    palette=cmap,
    sizes=(10, 100),
    ax=ax,
)
ax.set_yscale(&quot;log&quot;)
ax.set_xscale(&quot;log&quot;)
ax.set(xlabel=&quot;Right probability&quot;, ylabel=&quot;Left probability&quot;)
ax.plot([0.00001, 1], [0.00001, 1], color=&quot;grey&quot;, zorder=-2)

for i, row in sig_df.iterrows():
    ax.annotate(
        &quot;&quot;,
        (row[&quot;probabilities2&quot;], row[&quot;probabilities1&quot;]),
        xytext=(25, -25),
        textcoords=&quot;offset points&quot;,
        arrowprops=dict(arrowstyle=&quot;-|&gt;&quot;, color=&quot;black&quot;),
        ha=&quot;center&quot;,
        va=&quot;center&quot;,
        zorder=-1,
    )


ax = axs[1]
sns.scatterplot(
    data=melted_df,
    x=&quot;probabilities2&quot;,
    y=&quot;probabilities1&quot;,
    size=&quot;Sample size&quot;,
    hue=&quot;log10(p-value)&quot;,
    palette=cmap,
    sizes=(10, 100),
    ax=ax,
    legend=False,
)
ax.set_yscale(&quot;log&quot;)
ax.set_xscale(&quot;log&quot;)
ax.set(xlabel=&quot;Right probability&quot;, ylabel=&quot;&quot;)
ax.plot([0.00001, 1], [0.00001, 1], color=&quot;grey&quot;, zorder=-2)

for i, row in sig_df.iterrows():
    ax.annotate(
        &quot;&quot;,
        (row[&quot;probabilities2&quot;], row[&quot;probabilities1&quot;]),
        xytext=(25, -25),
        textcoords=&quot;offset points&quot;,
        arrowprops=dict(arrowstyle=&quot;-|&gt;&quot;, color=&quot;black&quot;),
        ha=&quot;center&quot;,
        va=&quot;center&quot;,
        zorder=-1,
    )
ax.set(
    xlim=(1e-2, 1),
    ylim=(1e-2, 1),
)

gluefig(&quot;probs_scatter&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
fig, ax = plt.subplots(1, 1, figsize=(10, 5))

group_counts_left = misc[&quot;group_counts1&quot;]
group_counts_right = misc[&quot;group_counts2&quot;]

for i in range(len(group_counts_left)):
    ax.bar(i - 0.17, group_counts_left[i], width=0.3, color=network_palette[&quot;Left&quot;])
    ax.bar(i + 0.17, group_counts_right[i], width=0.3, color=network_palette[&quot;Right&quot;])

rotate_labels(ax)
ax.set(
    ylabel=&quot;Count&quot;,
    xlabel=&quot;Group&quot;,
    xticks=np.arange(len(group_counts_left)) + 0.2,
    xticklabels=group_counts_left.index,
)
gluefig(&quot;group_counts&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<figure class="align-default" id="fig-sbm-unmatched-test-group-counts">
<div class="cell_output docutils container">
<img alt="_images/sbm_unmatched_test_11_0.png" src="_images/sbm_unmatched_test_11_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">The number of neurons in each group in each hemisphere. Note the similarity between
the hemispheres.</span><a class="headerlink" href="#fig-sbm-unmatched-test-group-counts" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
fig, axs = plot_stochastic_block_probabilities(misc, network_palette)

gluefig(&quot;sbm_uncorrected&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
# need to save this for later for setting colorbar the same on other plot
pvalue_vmin = np.log10(np.nanmin(misc[&quot;corrected_pvalues&quot;].values))
glue(&quot;pvalue_vmin&quot;, pvalue_vmin)

plot_pvalues(
    misc,
    pvalue_vmin,
    annot_missing=True,
)
gluefig(&quot;sbm_uncorrected_pvalues&quot;, fig)

plot_pvalues(
    misc,
    pvalue_vmin,
    annot_missing=False,
)
gluefig(&quot;sbm_uncorrected_pvalues_unlabeled&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>Next, we run the test for bilateral symmetry under the stochastic block model.
<a class="reference internal" href="#fig-sbm-unmatched-test-sbm-uncorrected"><span class="std std-numref">Figure 5</span></a> shows both the
estimated group-to-group probability matrices, <span class="math notranslate nohighlight">\(\hat{B}^{(L)}\)</span> and <span class="math notranslate nohighlight">\(\hat{B}^{(R)}\)</span>,
as well as the p-values from each test comparing each element of these matrices. From
a visual comparison of <span class="math notranslate nohighlight">\(\hat{B}^{(L)}\)</span> and <span class="math notranslate nohighlight">\(\hat{B}^{(R)}\)</span>
<a class="reference internal" href="#fig-sbm-unmatched-test-sbm-uncorrected"><span class="std std-numref">(Figure 5 A)</span></a>, we see that
the
group-to-group connection probabilities are qualitatively similar. Note also that some
group-to-group connection probabilities are zero, making it non-sensical to do a
comparision of binomial proportions. We highlight these elements in the <span class="math notranslate nohighlight">\(\hat{B}\)</span>
matrices with an explicit “0”, noting that we did not run the corresponding test in
these cases.</p>
<p>In <a class="reference internal" href="#fig-sbm-unmatched-test-sbm-uncorrected"><span class="std std-numref">Figure 5 B</span></a>, we see the
p-values from all <span class="pasted-text">284</span> that were run. After
Bonferroni-Holm correction, 5 tests yield p-values less than 0.05, indicating that
we reject the null hypothesis that those elements of the <span class="math notranslate nohighlight">\(\hat{B}\)</span> matrices are the
same between the two hemispheres. We also combine all p-values using Fisher’s method,
which yields an overall p-value for the entire null hypothesis in
Equation <a class="reference internal" href="#equation-sbm-unmatched-null">(1)</a> of
.</p>
<figure class="align-default" id="fig-sbm-unmatched-test-sbm-uncorrected">
<div class="cell_output docutils container">
<img alt="_images/sbm_unmatched_test_13_0.png" src="_images/sbm_unmatched_test_13_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">Comparison of stochastic block model fits for the left and right hemispheres.
<strong>A)</strong> The estimated group-to-group connection probabilities for the left
and right hemispheres appear qualitatively similar. Any estimated
probabilities which are zero (i.e. no edge was present between a given pair of
communities) is indicated explicitly with a “0” in that cell of the matrix.
<strong>B)</strong> The p-values for each hypothesis test between individual elements of
the block probability matrices. In other words, each cell represents a test for
whether a given group-to-group connection probability is the same on the left and the
right sides. “X” denotes a significant p-value after Bonferroni-Holm correction,
with <span class="math notranslate nohighlight">\(\alpha=0.05\)</span>. “B” indicates that a test was not run since the estimated
probability
was zero in that cell on both the left and right. “L” indicates this was the case on
the left only, and “R” that it was the case on the right only. These individual
p-values were combined using Fisher’s method, resulting in an overall p-value (for the
null hypothesis that the two group connection probability matrices are the same) of
.</span><a class="headerlink" href="#fig-sbm-unmatched-test-sbm-uncorrected" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="adjusting-for-a-difference-in-density">
<h2>Adjusting for a difference in density<a class="headerlink" href="#adjusting-for-a-difference-in-density" title="Permalink to this headline">#</a></h2>
<p>From <a class="reference internal" href="#fig-sbm-unmatched-test-sbm-uncorrected"><span class="std std-numref">Figure 5</span></a>, we see that
we have sufficient evidence to reject
the null hypothesis of bilateral symmetry under this version of the SBM. However,
we already saw in <a class="reference internal" href="er_unmatched_test.html"><span class="doc std std-doc">Density test</span></a> that the overall
densities between the two networks are different. Could it be that this rejection of
the null hypothesis under the SBM can be explained purely by this difference in
density? In other words, are the group-to-group connection probabilities on the right
simply a “scaled up” version of those on the right, where each probability is scaled
by the same amount?</p>
<p>In <a class="reference internal" href="#fig-sbm-unmatched-test-probs-uncorrected"><span class="std std-numref">Figure 6</span></a>,
we plot the estimated
probabilities on the left and the right hemispheres (i.e. each element of <span class="math notranslate nohighlight">\(\hat{B}\)</span>),
as
well as the difference between them. While subtle, we note that there is a slight
tendency for the left hemisphere estimated probability to be lower than the
corresponding one on the right. Specifically, we can also look at the group-to-group
connection probabilities which were significantly different in
<a class="reference internal" href="#fig-sbm-unmatched-test-sbm-uncorrected"><span class="std std-numref">Figure 5</span></a> - these are plotted
in <a class="reference internal" href="#fig-sbm-unmatched-test-significant-p-comparison"><span class="std std-numref">Figure 7</span></a>. Note
that in every case, the estimated probability on the right is higher with that on the
right.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>

def plot_estimated_probabilities(misc):
    B1 = misc[&quot;probabilities1&quot;]
    B2 = misc[&quot;probabilities2&quot;]
    null_odds = misc[&quot;null_ratio&quot;]
    B2 = B2 * null_odds
    B1_ravel = B1.values.ravel()
    B2_ravel = B2.values.ravel()
    arange = np.arange(len(B1_ravel))
    sum_ravel = B1_ravel + B2_ravel
    sort_inds = np.argsort(-sum_ravel)
    B1_ravel = B1_ravel[sort_inds]
    B2_ravel = B2_ravel[sort_inds]

    fig, axs = plt.subplots(2, 1, figsize=(10, 10), sharex=True)
    ax = axs[0]
    sns.scatterplot(
        x=arange,
        y=B1_ravel,
        color=network_palette[&quot;Left&quot;],
        ax=ax,
        linewidth=0,
        s=15,
        alpha=0.5,
    )
    sns.scatterplot(
        x=arange,
        y=B2_ravel,
        color=network_palette[&quot;Right&quot;],
        ax=ax,
        linewidth=0,
        s=15,
        alpha=0.5,
        zorder=-1,
    )
    ax.text(
        0.7,
        0.8,
        &quot;Left&quot;,
        color=network_palette[&quot;Left&quot;],
        transform=ax.transAxes,
    )
    ax.text(
        0.7,
        0.7,
        &quot;Right&quot;,
        color=network_palette[&quot;Right&quot;],
        transform=ax.transAxes,
    )
    ax.set_yscale(&quot;log&quot;)
    ax.set(
        ylabel=&quot;Estimated probability &quot; + r&quot;($\hat{p}$)&quot;,
        xticks=[],
        xlabel=&quot;Sorted group pairs&quot;,
    )
    ax.spines[&quot;bottom&quot;].set_visible(False)

    ax = axs[1]
    diff = B1_ravel - B2_ravel
    yscale = np.max(np.abs(diff))
    yscale *= 1.05
    sns.scatterplot(
        x=arange, y=diff, ax=ax, linewidth=0, s=25, color=neutral_color, alpha=1
    )
    ax.axhline(0, color=&quot;black&quot;, zorder=-1)
    ax.spines[&quot;bottom&quot;].set_visible(False)
    ax.set(
        xticks=[],
        ylabel=r&quot;$\hat{p}_{left} - \hat{p}_{right}$&quot;,
        xlabel=&quot;Sorted group pairs&quot;,
        ylim=(-yscale, yscale),
    )
    n_greater = np.count_nonzero(diff &gt; 0)
    n_total = len(diff)
    ax.text(
        0.3,
        0.8,
        f&quot;Left connection stronger ({n_greater}/{n_total})&quot;,
        color=network_palette[&quot;Left&quot;],
        transform=ax.transAxes,
    )
    n_lesser = np.count_nonzero(diff &lt; 0)
    ax.text(
        0.3,
        0.15,
        f&quot;Right connection stronger ({n_lesser}/{n_total})&quot;,
        color=network_palette[&quot;Right&quot;],
        transform=ax.transAxes,
    )

    fig.text(0.02, 0.905, &quot;A)&quot;, fontweight=&quot;bold&quot;, fontsize=30)
    fig.text(0.02, 0.49, &quot;B)&quot;, fontweight=&quot;bold&quot;, fontsize=30)

    return fig, ax


fig, ax = plot_estimated_probabilities(misc)
gluefig(&quot;probs_uncorrected&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<figure class="align-default" id="fig-sbm-unmatched-test-probs-uncorrected">
<div class="cell_output docutils container">
<img alt="_images/sbm_unmatched_test_17_0.png" src="_images/sbm_unmatched_test_17_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 6 </span><span class="caption-text">Comparison of estimated connection probabilities for the left and right hemispheres.
<strong>A)</strong> The estimated group-to-group connection probabilities (<span class="math notranslate nohighlight">\(\hat{p}\)</span>), sorted by
the mean left/right connection probability. Note the very subtle tendency for the
left probability to be lower than the corresponding one on the right. <strong>B)</strong> The
differences between corresponding group-to-group connection probabilities
(<span class="math notranslate nohighlight">\(\hat{p}^{(L)} - \hat{p}^{(R)}\)</span>). The trend of the left connection probabilities
being slightly smaller than the corresponding probability on the right is more
apparent here, as there are more negative than positive values.</span><a class="headerlink" href="#fig-sbm-unmatched-test-probs-uncorrected" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>

def plot_significant_probabilities(misc):
    B1 = misc[&quot;probabilities1&quot;]
    B2 = misc[&quot;probabilities2&quot;]
    null_odds = misc[&quot;null_ratio&quot;]
    B2 = B2 * null_odds
    index = B1.index
    uncorrected_pvalues = misc[&quot;uncorrected_pvalues&quot;]
    n_tests = misc[&quot;n_tests&quot;]

    alpha = 0.05
    hb_thresh = alpha / n_tests
    significant = uncorrected_pvalues &lt; hb_thresh

    row_inds, col_inds = np.nonzero(significant.values)

    rows = []
    for row_ind, col_ind in zip(row_inds, col_inds):
        source = index[row_ind]
        target = index[col_ind]
        left_p = B1.loc[source, target]
        right_p = B2.loc[source, target]
        pair = source + r&quot;$\rightarrow$&quot; + &quot;\n&quot; + target
        rows.append(
            {
                &quot;source&quot;: source,
                &quot;target&quot;: target,
                &quot;p&quot;: left_p,
                &quot;side&quot;: &quot;Left&quot;,
                &quot;pair&quot;: pair,
            }
        )
        rows.append(
            {
                &quot;source&quot;: source,
                &quot;target&quot;: target,
                &quot;p&quot;: right_p,
                &quot;side&quot;: &quot;Right&quot;,
                &quot;pair&quot;: pair,
            }
        )
    sig_data = pd.DataFrame(rows)

    mean_ps = sig_data.groupby(&quot;pair&quot;)[&quot;p&quot;].mean()
    pair_orders = mean_ps.sort_values(ascending=False).index

    fig, ax = plt.subplots(1, 1, figsize=(9, 6))
    sns.pointplot(
        data=sig_data,
        y=&quot;p&quot;,
        x=&quot;pair&quot;,
        ax=ax,
        hue=&quot;side&quot;,
        hue_order=[&quot;Right&quot;, &quot;Left&quot;],
        order=pair_orders,
        dodge=False,
        join=False,
        palette=network_palette,
        markers=&quot;_&quot;,
        scale=1.75,
    )
    ax.tick_params(axis=&quot;x&quot;, length=7)

    ax.set_yscale(&quot;log&quot;)
    ax.set_ylim((0.01, 1))

    leg = ax.get_legend()
    leg.set_title(&quot;Hemisphere&quot;)
    leg.set_frame_on(True)
    rotate_labels(ax)
    ax.set(xlabel=&quot;Group pair&quot;, ylabel=&quot;Connection probability&quot;)
    return fig, ax


fig, ax = plot_significant_probabilities(misc)
gluefig(&quot;significant_p_comparison&quot;, fig)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/bpedigo/JHU_code/bilateral/bilateral-connectome/.venv/lib/python3.9/site-packages/seaborn/categorical.py:1781: UserWarning: You passed a edgecolor/edgecolors ((0.9882352941176471, 0.5529411764705883, 0.3843137254901961)) for an unfilled marker (&#39;_&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax.scatter(x, y, label=hue_level,
/Users/bpedigo/JHU_code/bilateral/bilateral-connectome/.venv/lib/python3.9/site-packages/seaborn/categorical.py:1781: UserWarning: You passed a edgecolor/edgecolors ((0.4, 0.7607843137254902, 0.6470588235294118)) for an unfilled marker (&#39;_&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax.scatter(x, y, label=hue_level,
</pre></div>
</div>
</div>
</div>
<figure class="align-default" id="fig-sbm-unmatched-test-significant-p-comparison">
<div class="cell_output docutils container">
<img alt="_images/sbm_unmatched_test_19_1.png" src="_images/sbm_unmatched_test_19_1.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 7 </span><span class="caption-text">Comparison of estimated group-to-group connection probabilities for the group-pairs
which were significantly different in
<a class="reference internal" href="#fig-sbm-unmatched-test-sbm-uncorrected"><span class="std std-numref">Figure 5</span></a>.
In each case, the connection probability on the right hemisphere is higher.</span><a class="headerlink" href="#fig-sbm-unmatched-test-significant-p-comparison" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
fontsize = 8

methods = SmartSVG(FIG_PATH / &quot;sbm_methods_explain.svg&quot;)
methods.set_width(400)
methods.move(0, 15)
methods_panel = Panel(
    methods,
    Text(&quot;A) Group connection test methods&quot;, 5, 10, size=fontsize, weight=&quot;bold&quot;),
)

probs = SmartSVG(FIG_PATH / &quot;sbm_uncorrected.svg&quot;)
probs.set_width(400)
probs.move(0, 15)
probs_panel = Panel(
    probs,
    Text(
        &quot;B) Group connection probabilities&quot;,
        5,
        10,
        size=fontsize,
        weight=&quot;bold&quot;,
    ),
)
probs_panel.move(0, methods.height * 0.9)

pvalues = SmartSVG(FIG_PATH / &quot;sbm_uncorrected_pvalues.svg&quot;)
pvalues.set_width(200)
pvalues.move(10, 15)
pvalues_panel = Panel(
    pvalues, Text(&quot;C) Connection p-values&quot;, 5, 10, size=fontsize, weight=&quot;bold&quot;)
)
pvalues_panel.move(0, (methods.height + probs.height) * 0.9)

comparison = SmartSVG(FIG_PATH / &quot;significant_p_comparison.svg&quot;)
comparison.set_width(175)
comparison.move(2, 25)
comparison_panel = Panel(
    comparison,
    Text(&quot;D) Probabilities for&quot;, 5, 10, size=fontsize, weight=&quot;bold&quot;),
    Text(&quot;significant connections&quot;, 20, 20, size=fontsize, weight=&quot;bold&quot;),
)
comparison_panel.move(pvalues.width * 0.9, (methods.height + probs.height) * 0.9)

fig = Figure(
    methods.width * 0.8,
    (methods.height + probs.height + pvalues.height) * 0.9,
    methods_panel,
    probs_panel,
    pvalues_panel,
    comparison_panel,
)

fig.save(FIG_PATH / &quot;sbm_uncorrected_composite.svg&quot;)
fig
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/sbm_unmatched_test_21_0.svg" src="_images/sbm_unmatched_test_21_0.svg" /></div>
</div>
</section>
<section id="end">
<h2>End<a class="headerlink" href="#end" title="Permalink to this headline">#</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>elapsed = time.time() - t0
delta = datetime.timedelta(seconds=elapsed)
print(f&quot;Script took {delta}&quot;)
print(f&quot;Completed at {datetime.datetime.now()}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Script took 0:00:33.156568
Completed at 2022-09-26 11:37:35.131552
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="er_unmatched_test.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Density test</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="adjusted_sbm_unmatched_test.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Density-adjusted group connection test</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Benjamin D. Pedigo<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>